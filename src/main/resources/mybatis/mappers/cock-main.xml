<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cockMain">
	
	<select id="selectLatestRest" parameterType="locationVO" resultType="mainVO">
		SELECT r.rid, lat, lng, name, i.path AS img, COUNT(distinct a.article_id) AS count, max(a.write_dt) AS write_dt
		  FROM cc_rest r
		  LEFT JOIN cc_article a
			ON r.rid = a.rid
		  LEFT JOIN cc_img i
			ON a.rid = i.rid
		 WHERE lat >= #{lat} - 0.004 AND lat &lt;= #{lat} + 0.004 AND lng >= #{lng} - 0.0095 AND lng &lt;= #{lng} + 0.0095
		 GROUP BY rid
		 ORDER BY write_dt DESC
	</select>
	
	<select id="selectArticleRest" parameterType="locationVO" resultType="mainVO">
		SELECT r.rid, lat, lng, name, i.path AS img, COUNT(distinct a.article_id) AS count, max(a.write_dt) AS write_dt
		  FROM cc_rest r
		  LEFT JOIN cc_article a
			ON r.rid = a.rid 
		  LEFT JOIN cc_img i
			ON a.rid = i.rid
		 WHERE lat >= #{lat} - 0.004 AND lat &lt;= #{lat} + 0.004 AND lng >= #{lng} - 0.0095 AND lng &lt;= #{lng} + 0.0095		  		  
		 GROUP BY rid
		 ORDER BY count DESC
	</select>
	
	<select id="selectRecommendRest" resultType="mainVO">
		SELECT r.rid, lat, lng, name, i.path AS img, COUNT(distinct a.article_id) AS count, max(a.write_dt) AS write_dt
		  FROM cc_rest r
		  LEFT JOIN cc_article a
			ON r.rid = a.rid 
		  LEFT JOIN cc_img i
			ON a.rid = i.rid		 
		 GROUP BY rid
		 ORDER BY count DESC
		 LIMIT 10
	</select>
	
	<select id="selectTags" resultType="tagVO">
		SELECT t.rid, GROUP_CONCAT(distinct s.tag ORDER BY s.count DESC) AS tag
  		  FROM cc_tag t
  		  LEFT JOIN (
			SELECT rid, tag, COUNT(tag) AS count
      		  FROM cc_tag
			 GROUP BY rid, tag
			 ORDER BY count DESC
			) s
			ON t.rid = s.rid
 		 GROUP BY rid
	</select>
	
	<select id="selectTopFour" resultType="topFourVO">
		SELECT t.*, @rowNum := @rownum + 1 as rank
		  FROM (SELECT r.rid, name, i.path AS img, COUNT(distinct a.article_id) AS count
				  FROM cc_rest r
				  LEFT JOIN cc_img i
					ON r.rid = i.rid
				  LEFT JOIN cc_article a
					ON r.rid = a.rid
				 GROUP BY rid
				 ORDER BY count DESC
				 LIMIT 4) t, (SELECT @rownum := 0) r;
	</select>	
	
</mapper>